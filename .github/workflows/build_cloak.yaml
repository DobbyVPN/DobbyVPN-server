permissions:
  packages: write
  contents: read

name: Build and Push Docker Image(NEW)
on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main
  

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setting Cloak version
        run: |
          git clone https://github.com/cbeuw/Cloak.git
          cd Cloak
          VERSION=$(git describe --tags $(git rev-list --tags --max-count=1))
          cd ..
          git clone https://github.com/DobbyVPN/dobbyvpn-server.git
          cd dobbyvpn-server
          TMP=$(git describe --tags $(git rev-list --tags --max-count=1))
          LAST_NUM_str=`echo "$TMP" | grep -o '[0-9]\+$'`
          num=$(expr $LAST_NUM_str + 0)
          let "num=$num+1"
          LAST_NUM_str=$(expr $num + 0)
          VERSION=$VERSION'.'$LAST_NUM_str
          echo "CLOAK_VERSION=$VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build and Publish latest Docker image
        uses: DrSkunk/gp-docker-action@1.1.9
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          image-name: cloak-server
          dockerfile: Dockerfile-cloak-server
          image-tag: ${{ env.VERSION }}
